on: [pull_request]

permissions:
  contents: read
  pull-requests: read

jobs:
  dotnet-format-all:
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
          - windows-latest
        dotnet-format:
          - 3.1.37601
          - 3.2.107702
          - 3.3.111304
    runs-on: ${{ matrix.os }}
    steps:
      - id: meta
        shell: bash
        run: |
          _version="$(echo "${{ matrix.dotnet-format }}" | cut -c 1)"
          echo "::set-output name=version::${_version}"
      - uses: actions/checkout@v2.3.4
      - uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: "3.1.x"
      - run: dotnet --info
      - uses: xt0rted/dotnet-format-problem-matcher@preview
      - run: dotnet tool install --global dotnet-format --version ${{ matrix.dotnet-format }}
      - uses: xt0rted/dotnet-format@preview
        id: sdk-21
        with:
          version: ${{ steps.meta.outputs.version }}
          only-changed-files: false
          workspace: ./2.1
          fail-fast: false
      - uses: xt0rted/dotnet-format@preview
        id: sdk-31
        with:
          version: ${{ steps.meta.outputs.version }}
          only-changed-files: false
          workspace: ./3.1
          fail-fast: false
      - uses: xt0rted/dotnet-format@preview
        id: sdk-50
        with:
          version: ${{ steps.meta.outputs.version }}
          only-changed-files: false
          workspace: ./5.0
          fail-fast: false
      - run: exit 1
        if: steps.sdk-21.outputs.has-changes == 'true' || steps.sdk-31.outputs.has-changes == 'true' || steps.sdk-50.outputs.has-changes == 'true'
        shell: bash

  dotnet-format-changed:
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
          - windows-latest
        dotnet-format:
          - 3.1.37601
          - 3.2.107702
          - 3.3.111304
    runs-on: ${{ matrix.os }}
    steps:
      - id: meta
        shell: bash
        run: |
          _version="$(echo "${{ matrix.dotnet-format }}" | cut -c 1)"
          echo "::set-output name=version::${_version}"
      - uses: actions/checkout@v2.3.4
      - uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: "3.1.x"
      - run: dotnet --info
      - uses: xt0rted/dotnet-format-problem-matcher@preview
      - run: dotnet tool install --global dotnet-format --version ${{ matrix.dotnet-format }}
      - uses: xt0rted/dotnet-format@preview
        id: sdk-21
        with:
          version: ${{ steps.meta.outputs.version }}
          verbosity: diagnostic
          only-changed-files: true
          workspace: ./2.1
          fail-fast: false
      - uses: xt0rted/dotnet-format@preview
        id: sdk-31
        with:
          version: ${{ steps.meta.outputs.version }}
          verbosity: diagnostic
          only-changed-files: true
          workspace: ./3.1
          fail-fast: false
      - uses: xt0rted/dotnet-format@preview
        id: sdk-50
        with:
          version: ${{ steps.meta.outputs.version }}
          verbosity: diagnostic
          only-changed-files: true
          workspace: ./5.0
          fail-fast: false
      - run: exit 1
        if: steps.sdk-21.outputs.has-changes == 'true' || steps.sdk-31.outputs.has-changes == 'true' || steps.sdk-50.outputs.has-changes == 'true'
        shell: bash
